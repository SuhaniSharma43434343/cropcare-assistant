# CropCare Dashboard Feature\n\nThis document describes the implementation of the Crop Health Dashboard feature for the CropCare AI system.\n\n## Overview\n\nThe dashboard provides comprehensive analytics and insights based on crop disease scan records stored in the database. It calculates health scores, tracks trends, and provides disease breakdowns to help users monitor their crop health over time.\n\n## Features Implemented\n\n### 1. Overall Health Score\n- **Algorithm**: Starts at 100%, deducts points based on disease severity in last 7 days\n  - Mild: -5 points\n  - Moderate: -10 points  \n  - Severe: -20 points\n  - Healthy: No deduction\n- **Weekly Comparison**: Compares current week vs previous week health scores\n- **Active Issues**: Counts unique diseases (confidence >30%, excluding healthy scans)\n\n### 2. Health Trend (7-Day Line Graph)\n- Returns daily health scores for the last 7 days\n- Groups scans by day and calculates health score for each day\n- Returns data in format: `[{\"day\": \"Mon\", \"health\": 85}, ...]`\n\n### 3. Disease Breakdown (Monthly Bar Graph)\n- Aggregates disease occurrences for current month\n- Excludes healthy scans and low-confidence predictions (<30%)\n- Sorts by occurrence count (highest first)\n- Returns: `[{\"disease\": \"Late Blight\", \"count\": 12}, ...]`\n\n### 4. Recent Diagnoses\n- Shows last 10 scan records\n- Includes crop name, disease, severity, confidence, and formatted date\n- Date format: \"Today\", \"Yesterday\", or ISO date\n\n## API Endpoints\n\nAll endpoints require authentication (JWT token).\n\n### GET /api/dashboard/summary\nReturns overall health metrics.\n\n**Response:**\n```json\n{\n  \"overall_health\": 88,\n  \"weekly_change\": \"+5%\",\n  \"active_issues\": 3\n}\n```\n\n### GET /api/dashboard/health-trend\nReturns 7-day health trend data.\n\n**Response:**\n```json\n[\n  { \"day\": \"Mon\", \"health\": 85 },\n  { \"day\": \"Tue\", \"health\": 83 },\n  { \"day\": \"Wed\", \"health\": 90 },\n  { \"day\": \"Thu\", \"health\": 88 },\n  { \"day\": \"Fri\", \"health\": 92 },\n  { \"day\": \"Sat\", \"health\": 89 },\n  { \"day\": \"Sun\", \"health\": 88 }\n]\n```\n\n### GET /api/dashboard/disease-breakdown\nReturns monthly disease occurrence counts.\n\n**Response:**\n```json\n[\n  { \"disease\": \"Late Blight\", \"count\": 12 },\n  { \"disease\": \"Leaf Spot\", \"count\": 8 },\n  { \"disease\": \"Early Blight\", \"count\": 5 }\n]\n```\n\n### GET /api/dashboard/recent-diagnoses\nReturns recent scan results.\n\n**Response:**\n```json\n[\n  {\n    \"crop_name\": \"Tomato\",\n    \"disease_name\": \"Late Blight\",\n    \"severity\": \"Severe\",\n    \"confidence\": 92,\n    \"date\": \"Today\"\n  },\n  {\n    \"crop_name\": \"Wheat\",\n    \"disease_name\": \"Healthy\",\n    \"severity\": \"Healthy\",\n    \"confidence\": 95,\n    \"date\": \"Yesterday\"\n  }\n]\n```\n\n## Database Schema\n\n### ScanRecord Model\n```javascript\n{\n  userId: ObjectId,           // Reference to user\n  crop_name: String,          // Name of the crop\n  disease_name: String,       // Disease identified\n  confidence: Number,         // Confidence score (0-100)\n  severity: String,           // 'Healthy', 'Mild', 'Moderate', 'Severe'\n  timestamp: Date,            // When scan was performed\n  mlResult: Mixed            // Full ML service response\n}\n```\n\n## Files Created/Modified\n\n### New Files:\n1. `src/models/ScanRecord.js` - Database model for scan records\n2. `src/controllers/dashboardController.js` - Dashboard logic and calculations\n3. `src/routes/dashboard.js` - Dashboard API routes\n4. `create-sample-dashboard-data.js` - Script to create test data\n5. `test-dashboard-api.js` - API testing script\n\n### Modified Files:\n1. `src/server.js` - Added dashboard routes and updated ML prediction to save scan records\n\n## Setup Instructions\n\n1. **Install Dependencies** (already included in package.json):\n   ```bash\n   npm install\n   ```\n\n2. **Create Sample Data** (for testing):\n   ```bash\n   node create-sample-dashboard-data.js\n   ```\n\n3. **Test API Endpoints**:\n   ```bash\n   node test-dashboard-api.js\n   ```\n\n4. **Start Server**:\n   ```bash\n   npm start\n   ```\n\n## Data Flow\n\n1. **Scan Creation**: When users perform disease scans via `/api/ml/predict`, scan records are automatically saved to the database\n2. **Dashboard Queries**: Dashboard endpoints query scan records and perform calculations\n3. **Real-time Updates**: All dashboard data is calculated dynamically from stored scan records\n\n## Key Features\n\n- **Dynamic Calculations**: All metrics calculated from actual scan data, no hardcoded values\n- **User-Specific**: All data filtered by authenticated user\n- **Offline Compatible**: Works with local database, no external dependencies\n- **Efficient Queries**: Optimized database queries with proper indexing\n- **Clean Separation**: Business logic separated into controller functions\n\n## Testing\n\nThe implementation includes comprehensive testing:\n- Sample data creation script\n- API endpoint validation\n- Response structure verification\n- Authentication testing\n\n## Production Considerations\n\n- Database indexes are created for efficient querying\n- Error handling for all edge cases\n- Input validation and sanitization\n- Proper authentication middleware\n- Scalable architecture for future enhancements